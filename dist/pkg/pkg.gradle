tasks.register('createPkg', Exec) {
    dependsOn baseDist
    commandLine "$projectDir/pkg/build-pkg.sh",
                versionString,
                canonicalVersionString,
                arch.toString(),
                productName,
                kebapProductName,
                groupName + "." + kebapProductName,
                productName.replaceAll(' ', '%20'),
                "${artifactBaseName}-installer-macos-${arch}.pkg"

    doLast {
        if (System.getenv("MACOS_NOTARIZATION_APPLE_ID") != null) {
            System.out.println(System.getenv("MACOS_NOTARIZATION_APPLE_ID"))
            providers.exec {
                commandLine "$projectDir/pkg/notarize_pkg.sh", "${project.layout.buildDirectory.get()}/dist/pkg_target/pkg/${artifactBaseName}-installer-macos-${arch}.pkg"
            }.getResult().get()
        }

        copy {
            from "${project.layout.buildDirectory.get()}/dist/pkg_target/pkg/"
            into "${project.layout.buildDirectory.get()}/dist/artifacts"
        }
    }
}

dist.finalizedBy(createPkg)
