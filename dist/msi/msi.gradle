def distDir = "${project.layout.buildDirectory.get()}/dist"

// TODO: Change this to a random UUID!
def RELEASE_PRODUCT_CODE = '{fb687ed1-5446-4d4b-be8a-b98e3b6f6039}'

tasks.register('installerDist', DefaultTask) {
    dependsOn baseDist
    doLast {
        copy {
            from "$distDir/base"
            into "$distDir/installer-win"
        }
        copy {
            from "$projectDir/msi/installation"
            into "$distDir/installer-win"
        }
    }
}

tasks.register('signInstaller', Exec) {
    commandLine "$projectDir\\tools\\sign.bat", "$distDir/artifacts/$artifactBaseName-installer-windows-${arch}.msi"
    ignoreExitValue = !ci
}

tasks.register('buildInstaller', Exec) {
    dependsOn installerDist
    commandLine 'cmd', '/c', 'CALL', projectDir.toString() + "/msi/build_installer_${arch}.bat"
    environment('PRODUCT_CODE', RELEASE_PRODUCT_CODE)
    environment('PRODUCT_NAME', productName)
    environment('CANONICAL_VERSION', windowsSchemaCanonicalVersion)
    environment('EXECUTABLE_NAME', jpackageExecutableName)
    environment('ARTIFACT_NAME', artifactBaseName)
}

buildInstaller.finalizedBy(signInstaller)
dist.finalizedBy(buildInstaller)